#!/usr/bin/env zsh

function refresh_aws_credentials {
  local profile="${1:-${AWS_PROFILE:-default}}"
  local log_file="${HOME}/.aws/refresh.log"
  local timestamp="$(date '+%Y-%m-%d %H:%M:%S')"
  
  # Ensure log directory exists
  mkdir -p "$(dirname "$log_file")"
  
  echo "[$timestamp] Refreshing AWS credentials for profile: $profile" >> "$log_file"
  
  # Set AWS_PROFILE for this operation
  export AWS_PROFILE="$profile"
  
  # Attempt to refresh credentials with timeout
  if timeout 30 aws sts get-caller-identity >> "$log_file" 2>&1; then
    echo "[$timestamp] SUCCESS: Credentials refreshed for profile $profile" >> "$log_file"
    echo "AWS credentials refreshed successfully for profile: $profile"
    return 0
  else
    local exit_code=$?
    echo "[$timestamp] ERROR: Failed to refresh credentials for profile $profile (exit code: $exit_code)" >> "$log_file"
    echo "ERROR: Failed to refresh AWS credentials for profile: $profile" >&2
    return $exit_code
  fi
}
